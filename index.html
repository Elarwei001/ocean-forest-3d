<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ocean Forest - WebGL Octopus Adventure</title>
    <link rel="stylesheet" href="assets/styles/webgl-style.css">
</head>
<body>
    <!-- WebGL Canvas -->
    <canvas id="webgl-canvas"></canvas>
    
    <!-- Loading screen -->
    <div id="loading-screen">
        <div class="loading-content">
            <h2>🌊 Loading Ocean Forest...</h2>
            <div class="loading-bar">
                <div class="loading-progress"></div>
            </div>
            <p>Preparing your underwater adventure</p>
        </div>
    </div>
    
    <!-- UI Overlay -->
    <div id="ui-overlay">
        <div id="controls">
            <h3>🐙 Octopus Controls</h3>
            <p><strong>WASD/Arrow Keys:</strong> Move around</p>
            <p><strong>Mouse:</strong> Look around</p>
            <p><strong>M Key:</strong> Toggle mouse control</p>
            <p><strong>Space:</strong> Swim up</p>
            <p><strong>Shift:</strong> Swim down</p>
            <div class="info">Welcome to South African Ocean Forest</div>
        </div>
        
        <div id="performance">
            <div>FPS: <span id="fps">60</span></div>
            <div>🌿 Kelp: <span id="kelp-count">0</span></div>
            
            <!-- Interactive Marine Life Controls -->
            <div class="animal-control">
                <span>🐟 Fish: <span id="fish-count">0</span></span>
                <button class="control-btn" onclick="removeFish()">-</button>
                <button class="control-btn" onclick="addFish()">+</button>
            </div>
            
            <div class="animal-control">
                <span>🦭 Seals: <span id="seal-count">0</span></span>
                <button class="control-btn" onclick="removeSeal()">-</button>
                <button class="control-btn" onclick="addSeal()">+</button>
            </div>
            
            <div class="animal-control">
                <span>🐧 Penguins: <span id="penguin-count">0</span></span>
                <button class="control-btn" onclick="removePenguin()">-</button>
                <button class="control-btn" onclick="addPenguin()">+</button>
            </div>
            
            <div class="animal-control">
                <span>🦈 Sharks: <span id="shark-count">0</span></span>
                <button class="control-btn" onclick="removeShark()">-</button>
                <button class="control-btn" onclick="addShark()">+</button>
            </div>
        </div>
        
        <!-- Fish Follow Panel -->
        <div id="fish-follow-panel" style="position: absolute !important; bottom: 20px !important; right: 20px !important; top: auto !important; left: auto !important; z-index: 1000 !important;">
            <h4>🎯 Follow Fish</h4>
            <div id="follow-buttons-container">
                <p class="no-fish-message">Add fish to see follow options</p>
            </div>
            <button id="stop-follow-btn" class="stop-follow-btn" onclick="stopFollowingAll()" style="display: none;">
                Stop Following
            </button>
        </div>
        
        <!-- Educational Information Panel -->
        <div id="species-info" class="hidden">
            <div class="species-content">
                <button id="close-info" class="close-btn">×</button>
                <div class="species-header">
                    <div class="species-photo">
                        <img id="species-image" src="" alt="Species Photo" />
                        <div class="photo-credit">📸 Photo</div>
                    </div>
                    <div class="species-names">
                        <h3 id="species-name"></h3>
                        <h4 id="species-english"></h4>
                    </div>
                </div>
                <div id="species-facts"></div>
                <p class="info-hint">🖱️ 点击海洋生物了解更多知识 / Click marine animals to learn more</p>
            </div>
        </div>
    </div>
    
    <!-- Three.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <!-- Module Manager (must load first) -->
    <script src="src/core/ModuleManager.js"></script>
    
    <!-- Core Modules -->
    <script src="src/core/OceanForest.js"></script>
    
    <!-- Model Modules -->
    <script src="src/models/OceanEnvironment.js"></script>
    <script src="src/models/OctopusModel.js"></script>
    <script src="src/models/MarineAnimals.js"></script>
    <script src="src/models/SharkModel.js"></script>
    <script src="src/models/ReefFishModel.js"></script>
    <script src="src/models/SharksAndFish.js"></script>
    
    <!-- System Modules -->
    <script src="src/systems/AudioSystem.js"></script>
    <script src="src/systems/EducationSystem.js"></script>
    <script src="src/systems/RenderEngine.js"></script>

    <!-- Cinematic Systems -->
    <script src="src/systems/CinematicAnimationSystem.js"></script>
    <script src="src/systems/AdvancedParticleSystem.js"></script>
    <script src="src/systems/MarineLifeBehavior.js"></script>
    <script src="src/systems/CinematicCameraSystem.js"></script>
    <script src="src/systems/PhotogrammetrySystem.js"></script>
    <script src="src/systems/AIDepthEstimation.js"></script>
    <script src="src/systems/ProceduralModelGenerator.js"></script>
    <script src="src/systems/Advanced3DModelSystem.js"></script>
    
    <!-- Testing System -->
    <script src="src/tests/3DModelGenerationTest.js"></script>
    
    <!-- Main Application Initialization -->
    <script>
        // Initialize Ocean Forest Application
        let oceanForest = null;
        
        // Marine Life Control Functions
        function addFish() {
            console.log('🐟 addFish button clicked!');
            
            // Find and disable the button temporarily
            const fishButtons = document.querySelectorAll('button[onclick="addFish()"]');
            fishButtons.forEach(btn => btn.disabled = true);
            
            try {
                // Check if Ocean Forest is initialized
                if (!oceanForest) {
                    alert('⏳ Ocean Forest is still loading. Please wait a moment...');
                    console.log('❌ oceanForest not initialized yet');
                    return;
                }
                
                // Check if the required method exists
                if (!oceanForest.addCapeReefFish) {
                    alert('❌ Fish creation system not available');
                    console.error('❌ addCapeReefFish method not found');
                    console.log('Available methods:', Object.keys(oceanForest));
                    return;
                }
                
                // Fish creation is now built directly into addCapeReefFish method
                // No external dependencies required
                
                console.log('🐟 Calling oceanForest.addCapeReefFish()...');
                const result = oceanForest.addCapeReefFish();
                
                if (result) {
                    console.log('✅ Fish added successfully');
                    // Show a non-blocking success message
                    const fishCount = document.getElementById('fish-count');
                    if (fishCount) {
                        fishCount.style.color = '#00ff00';
                        setTimeout(() => fishCount.style.color = '', 1000);
                    }
                } else {
                    alert('❌ Failed to add fish');
                    console.error('❌ addCapeReefFish returned null/undefined');
                }
            } catch (error) {
                alert('❌ Error adding fish: ' + error.message);
                console.error('❌ Error in addFish():', error);
            } finally {
                // Re-enable buttons
                setTimeout(() => {
                    fishButtons.forEach(btn => btn.disabled = false);
                }, 500);
            }
        }
        
        function removeFish() {
            if (oceanForest && oceanForest.removeCapeReefFish) {
                const removed = oceanForest.removeCapeReefFish();
                if (removed) {
                    console.log('🐟 Removed fish');
                } else {
                    console.log('🐟 No fish to remove');
                }
            }
        }
        
        function addSeal() {
            if (oceanForest && oceanForest.addCapeFurSeal) {
                oceanForest.addCapeFurSeal();
                console.log('🦭 Added seal');
            }
        }
        
        function removeSeal() {
            if (oceanForest && oceanForest.removeCapeFurSeal) {
                const removed = oceanForest.removeCapeFurSeal();
                if (removed) {
                    console.log('🦭 Removed seal');
                } else {
                    console.log('🦭 No seal to remove');
                }
            }
        }
        
        function addPenguin() {
            if (oceanForest && oceanForest.addAfricanPenguin) {
                oceanForest.addAfricanPenguin();
                console.log('🐧 Added penguin');
            }
        }
        
        function removePenguin() {
            if (oceanForest && oceanForest.removeAfricanPenguin) {
                const removed = oceanForest.removeAfricanPenguin();
                if (removed) {
                    console.log('🐧 Removed penguin');
                } else {
                    console.log('🐧 No penguin to remove');
                }
            }
        }
        
        function addShark() {
            if (oceanForest && oceanForest.addGreatWhiteShark) {
                oceanForest.addGreatWhiteShark();
                console.log('🦈 Added shark');
            }
        }
        
        function removeShark() {
            if (oceanForest && oceanForest.removeGreatWhiteShark) {
                const removed = oceanForest.removeGreatWhiteShark();
                if (removed) {
                    console.log('🦈 Removed shark');
                } else {
                    console.log('🦈 No shark to remove');
                }
            }
        }
        
        function stopFollowingAll() {
            if (oceanForest && oceanForest.stopFollowingAll) {
                oceanForest.stopFollowingAll();
            }
        }
        
        window.addEventListener('load', async () => {
            try {
                // Wait for all modules to load
                if (window.moduleManager) {
                    console.log('🔄 Waiting for modules to load...');
                    const moduleReady = await window.moduleManager.waitForModules();
                    
                    if (moduleReady) {
                        // Initialize main application
                        const OceanForest = window.moduleManager.getModule('OceanForest');
                        if (OceanForest) {
                            oceanForest = new OceanForest();
                            window.oceanForest = oceanForest; // Make globally available
                            
                            console.log('🌊 Ocean Forest Application Started');
                            console.log('🎬 Initializing cinematic systems...');
                            
                            // Add visual indicator that system is ready
                            setTimeout(() => {
                                const controls = document.getElementById('controls');
                                if (controls) {
                                    const readyIndicator = document.createElement('div');
                                    readyIndicator.style.cssText = 'color: #00ff00; margin-top: 10px; font-weight: bold;';
                                    readyIndicator.textContent = '✅ System Ready - Marine controls active';
                                    controls.appendChild(readyIndicator);
                                }
                                console.log('🎯 Ocean Forest system fully ready for interaction');
                            }, 2000);
                            
                        } else {
                            console.error('❌ OceanForest module not found');
                        }
                    } else {
                        console.error('❌ Required modules failed to load');
                    }
                } else {
                    console.error('❌ Module manager not found');
                }
            } catch (error) {
                console.error('❌ Application initialization failed:', error);
            }
        });
    </script>
</body>
</html>